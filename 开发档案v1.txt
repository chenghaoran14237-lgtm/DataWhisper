ä¸‹é¢ç»™ä½ ä¸€ä»½æˆ‘å·²ç»â€œæŒ‰ä½ åˆšæ‰é‚£æ®µè¯„å®¡æ„è§â€æ‰“ç£¨è¿‡çš„ **DataWhisperï¼ˆExcel Agentï¼‰å¼€å‘æ¡£æ¡ˆ v1.1ï¼ˆå¯äº¤æ¥/å¯å¤åˆ»ï¼‰**ã€‚å®ƒçš„å†™æ³•æ˜¯ï¼š**èƒ½ç¡®å®šçš„å†™æˆäº‹å®+ä½ç½®**ï¼›ä¸èƒ½ç¡®å®šçš„å…¨éƒ¨æ ‡æˆ**çº¦å®š/å¾…æ ¸å¯¹**ï¼Œé¿å…æœªæ¥è¯¯å¯¼ã€‚

---

# DataWhisperï¼ˆExcel Agentï¼‰å¼€å‘æ¡£æ¡ˆ v1.1ï¼ˆå¯äº¤æ¥/å¯å¤åˆ»ï¼‰

## 0. è¿™æ˜¯ä»€ä¹ˆï¼ˆé¡¹ç›®ä¸€å¥è¯ï¼‰

ç”¨æˆ·ä¸Šä¼  `.xlsx` â†’ åç«¯è¯»æˆ `pandas.DataFrame` â†’ Planner ç”Ÿæˆå·¥å…·é“¾ï¼ˆgroupby/sum/sort/chartâ€¦ï¼‰æ‰§è¡Œ â†’ LLM **åªåŸºäºå·¥å…·è¾“å‡º**å†™è§£é‡Šæ€§å›å¤ â†’ è¿”å› `reply + artifacts(chart specâ€¦)`ï¼Œå¹¶æŠŠå¯¹è¯ä¸ debug trace å†™å…¥ MySQLï¼Œä¾›å¤ç›˜ä¸å‰ç«¯å±•ç¤ºã€‚ 

---

## 1. â€œäº‹å® vs çº¦å®šâ€çš„æ ‡è®°è§„åˆ™ï¼ˆé˜²æ­¢ä½ æœªæ¥è¢«è‡ªå·±å‘ï¼‰

* âœ… **å·²å®ç°/å·²åœ¨è¿è¡Œä¸­å‡ºç°è¿‡çš„äº‹å®**ï¼šæˆ‘ä¼šå†™æ¸…æ¥šâ€œä½ç½®ï¼šapp/xxx.pyâ€ï¼ˆæ¥æºï¼šä½ è·‘ uvicorn/pytest çš„æ ˆä¿¡æ¯ã€ä½ è´´è¿‡çš„ä»£ç ç‰‡æ®µï¼‰ã€‚
* ğŸ“Œ **é¡¹ç›®çº¦å®šï¼ˆå¸Œæœ›ç³»ç»Ÿå°±è¯¥è¿™æ ·ï¼‰**ï¼šå¯¹å¤–åˆåŒ/è§„èŒƒå¯ä»¥å…ˆå†™çº¦å®šï¼Œä½†ä¼šæ˜ç¡®å®ƒæ˜¯å¥‘çº¦ï¼Œä¸å†’å……äº‹å®ã€‚
* âš ï¸ **å¾…æ ¸å¯¹ï¼ˆéœ€è¦ä½ æ‰“å¼€ä»“åº“ç¡®è®¤ï¼‰**ï¼šæˆ‘ä¼šå†™â€œTODO: ä»¥å®é™…ä»£ç ä¸ºå‡†â€ã€‚

---

## 2. è¿è¡Œç¯å¢ƒä¸ä¸€é”®å¤åˆ»ï¼ˆå¼ºçº¦æŸï¼šå¯å¤ç°ï¼‰

### 2.1 é¡¹ç›®è·¯å¾„ï¼ˆäº‹å®ï¼‰

* Windows åç«¯è·¯å¾„ï¼š`C:\DataWhisper\backend`ï¼ˆä½ ä¸€ç›´åœ¨æ­¤ç›®å½•è¿è¡Œ pytest/uvicornï¼‰

### 2.2 Python ç‰ˆæœ¬ï¼ˆå¾…è¡¥ï¼šå¿…é¡»å†™â€œå®é™…è¾“å‡ºâ€ï¼‰

* âš ï¸ TODO å†™å…¥ï¼š`python --version` çš„çœŸå®è¾“å‡ºï¼ˆä¸è¦â€œä»æŠ¥é”™æ¨æ–­â€â€”â€”ä½ è‡ªå·±å·²ç»è¸©è¿‡è¿™ç§å‘ï¼‰

### 2.3 ä¾èµ–é”å®šï¼ˆè¿ç§»æœ€å®¹æ˜“ç¿»è½¦çš„ç‚¹ï¼‰

ğŸ“Œ çº¦å®šï¼šä»“åº“æ ¹ç›®å½•å¿…é¡»åŒ…å«ä»¥ä¸‹å…¶ä¸€ï¼š

* `requirements.txt`ï¼ˆæ¨è demo é¡¹ç›®ï¼‰æˆ– `pyproject.toml/poetry.lock`

ğŸ“Œ æ¨èç”Ÿæˆæ–¹å¼ï¼ˆWindows PowerShellï¼‰ï¼š

```powershell
# åœ¨ backend ç›®å½•
python -m venv .venv
.\.venv\Scripts\activate
python -m pip install -U pip
pip install -r requirements.txt
```

âš ï¸ TODOï¼ˆå†»ç»“ç‰ˆæœ¬æ—¶å¡«å…¥ï¼‰ï¼š

* `pip freeze > requirements.txt`
* åœ¨æ¡£æ¡ˆé‡Œé™„ä¸Š â€œå…³é”®ä¾èµ– pinned ç‰ˆæœ¬â€ï¼ˆfastapi/sqlalchemy/pydantic/pandas/aiomysql/openpyxl/httpx/pytest/pytest-asyncio ç­‰ï¼‰

> ä½ ä¹‹å‰é‡åˆ°è¿‡ï¼š`aiomysql` ç¼ºå¤±ã€`cryptography` ç¼ºå¤±å¯¼è‡´ MySQL `caching_sha2_password` è®¤è¯å¤±è´¥â€”â€”è¿™ç±»é—®é¢˜ 90% éƒ½æ˜¯ç‰ˆæœ¬/ä¾èµ–æ²¡é”å¥½å¼•å‘çš„ã€‚

---

## 3. MySQL åˆå§‹åŒ–ï¼ˆæŠŠâ€œèƒ½è·‘èµ·æ¥â€å†™æˆè„šæœ¬ï¼‰

### 3.1 æ•°æ®åº“ï¼ˆäº‹å®/çº¦å®šæ··åˆï¼‰

* âœ… é¡¹ç›®ä½¿ç”¨ `DATABASE_URL` ç¯å¢ƒå˜é‡è¿æ¥ MySQLï¼ˆä½ æµ‹è¯•é‡Œä¸€ç›´è¿™ä¹ˆé…ï¼‰
* âœ… æµ‹è¯•åº“ï¼š`datawhisper_test`ï¼ˆpytest ç”¨å®ƒ drop/createï¼‰
* ğŸ“Œ çº¦å®šå­—ç¬¦é›†ï¼š`utf8mb4`

### 3.2 å»ºåº“/å»ºç”¨æˆ·/æˆæƒï¼ˆç›´æ¥ç»™å¯å¤åˆ¶ SQLï¼‰

ğŸ“Œ æ¨èï¼ˆæœ¬æœºå¼€å‘ç”¨ï¼‰ï¼š

```sql
CREATE DATABASE IF NOT EXISTS datawhisper
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

CREATE DATABASE IF NOT EXISTS datawhisper_test
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

-- å…¼å®¹ä¸åŒ hostï¼š127.0.0.1 / localhost
CREATE USER IF NOT EXISTS 'datawhisper'@'127.0.0.1' IDENTIFIED BY 'dwpass';
CREATE USER IF NOT EXISTS 'datawhisper'@'localhost' IDENTIFIED BY 'dwpass';

GRANT ALL PRIVILEGES ON datawhisper.* TO 'datawhisper'@'127.0.0.1';
GRANT ALL PRIVILEGES ON datawhisper.* TO 'datawhisper'@'localhost';
GRANT ALL PRIVILEGES ON datawhisper_test.* TO 'datawhisper'@'127.0.0.1';
GRANT ALL PRIVILEGES ON datawhisper_test.* TO 'datawhisper'@'localhost';
FLUSH PRIVILEGES;
```

ğŸ“Œ è§£é‡Šï¼šä½ æåˆ°çš„â€œ127.0.0.1 vs localhostâ€ host åŒ¹é…é—®é¢˜ï¼Œæ˜¯ MySQL æƒé™æ¨¡å‹çš„ç»å…¸å‘ï¼›è¿™é‡Œç›´æ¥åŒå†™å…œåº•ã€‚

---

## 4. æ•°æ®è¡¨ç»“æ„ï¼ˆå­—æ®µçº§ï¼Œé¿å…â€œæ¦‚å¿µäº¤æ¥â€ï¼‰

> ä¸‹é¢æ˜¯**æ¡£æ¡ˆå±‚é¢çš„å­—æ®µå¥‘çº¦**ï¼Œæ¥æºäºä½ çš„ç»“æ„æ–‡æ¡£ï¼›ä¸Šçº¿å‰è¯·ç”¨ ORM çœŸå®å­—æ®µå¯¹é½å¹¶åœ¨æ¯å¼ è¡¨åé¢è¡¥â€œä½ç½®ï¼šapp/models/xxx.pyâ€ã€‚ 

### 4.1 messagesï¼ˆå¯¹è¯æ¶ˆæ¯è¡¨ï¼‰

ğŸ“Œ å­—æ®µï¼ˆçº¦å®šï¼‰ 

* `id` UUID
* `session_id` UUIDï¼ˆå»ºè®®å»ºç´¢å¼•ï¼‰
* `role` stringï¼š`user|assistant|system`
* `content` text
* `created_at` datetime
* `summarized` bool
* `token_count` intï¼ˆå¯é€‰ï¼‰
* `extra` JSONï¼ˆå…³é”®ï¼šå­˜ debug/artifacts ç­‰ï¼‰

ğŸ“Œ extra çº¦å®šï¼ˆç™½åå•ï¼ŒåŠ¡å¿…å›ºå®š keyï¼Œå‰ç«¯å’Œæµ‹è¯•éƒ½é å®ƒï¼‰ï¼š

```json
{
  "debug": {
    "plan": [{"tool":"groupby_sum","args":{}}],
    "tool_trace": [{"tool":"groupby_sum","args":{},"output_kind":"table","output_preview":"..."}],
    "artifacts": [{"kind":"chart","spec":{}}],
    "profile": {"rows": 123, "cols": 7, "columns": ["a","b"]}
  }
}
```

### 4.2 summariesï¼ˆå¯¹è¯æ‘˜è¦è¡¨ï¼‰

ğŸ“Œ å­—æ®µï¼ˆçº¦å®šï¼‰ 

* `id` UUID
* `session_id` UUIDï¼ˆå»ºè®®ç´¢å¼•ï¼‰
* `content` text
* `up_to_message_id` UUID
* `created_at` datetime

---

## 5. é…ç½®ä¸ Settingsï¼ˆä½ æ›¾ç»åœ¨è¿™é‡Œè¸©å¤§å‘ï¼šé‡å¤ class å¯¼è‡´æ‰¾ä¸åˆ°å­—æ®µï¼‰

### 5.1 äº‹å®ï¼ˆä½ é‡åˆ°çš„æŠ¥é”™è¯´æ˜äº†ä»€ä¹ˆï¼‰

ä½ è·‘ `uvicorn app.main:app --reload` æ—¶å‡ºç°è¿‡ï¼š

* `Settings` æ²¡æœ‰ `app_name`
* `Settings` æ²¡æœ‰ `api_prefix`

è¿™ç±»æŠ¥é”™å‡ ä¹å¿…ç„¶ç”± **Settings å®šä¹‰é‡å¤/è¦†ç›–** æˆ– â€œå­—æ®µåä¸ alias ä¸ä¸€è‡´â€é€ æˆã€‚

### 5.2 ğŸ“Œ çº¦å®šï¼šSettings åªä¿ç•™ä¸€ä¸ª classï¼Œå­—æ®µç»Ÿä¸€ï¼ˆå»ºè®®æ¨¡æ¿ï¼‰

ï¼ˆè¿™æ˜¯â€œæ¡£æ¡ˆç»™æœªæ¥ç»´æŠ¤è€…â€çš„ç¡¬è§„åˆ™ï¼‰

* åªå®šä¹‰ä¸€ä¸ª `class Settings(BaseSettings)`
* æ‰€æœ‰ env key ç”¨ `alias=...` æ˜¾å¼ç»‘å®š
* `get_settings()` ç”¨ `@lru_cache` ç¼“å­˜
* `extra="ignore"` é˜²æ­¢ .env å¤šå†™å­—æ®µç›´æ¥ç‚¸

ï¼ˆä½ æŠŠä¸¤ä¸ª Settings åˆå¹¶æˆä¸€ä¸ªå°±èƒ½é¿å…å†æ¬¡å‡ºç° â€œæ²¡æœ‰ api_prefix/app_nameâ€ã€‚ï¼‰

---

## 6. åç«¯æ ¸å¿ƒé“¾è·¯ï¼ˆå‡½æ•°çº§â€œä¸šåŠ¡æ€ä¹ˆè·‘èµ·æ¥â€ï¼‰

ä¸‹é¢æ˜¯ä½  Excel Agent çš„â€œé»„é‡‘è·¯å¾„â€ï¼Œä¹Ÿæ˜¯å‰ç«¯æ¥å…¥æ—¶å¿…é¡»æ‡‚çš„é“¾è·¯ï¼š 

### 6.1 ä¸Šä¼ ï¼šPOST `/api/excel/upload`

ğŸ“Œ ç›®æ ‡ï¼šæŠŠ Excel è½ç›˜ + å…¥åº“ file_uploads + è¿”å› `session_id/upload_id`

* å…¥å£ï¼ˆäº‹å®ï¼Œæ¥è‡ªæ ˆä¿¡æ¯ï¼‰ï¼š`ä½ç½®ï¼šapp/api/excel_api.py`
* ä¸šåŠ¡ï¼ˆçº¦å®šï¼Œå’Œä½ çš„è®¾è®¡ä¸€è‡´ï¼‰ï¼šExcelService åšæ ¡éªŒ/å­˜å‚¨/è¯»è¡¨/ç¼“å­˜ 

### 6.2 å¯¹è¯ï¼šPOST `/api/excel/chat`

ğŸ“Œ è¯·æ±‚å“åº”ï¼ˆçº¦å®šï¼‰ 

* Request: `{session_id, upload_id, message}`
* Response: `{reply, session_id, upload_id, artifacts: []}`

  > artifacts å¿…é¡»æ°¸è¿œæ˜¯ listï¼ˆä½ å·²ç»åœ¨ schema é‡Œè¿™ä¹ˆåšäº†ï¼‰

ğŸ“Œ æ‰§è¡Œæ­¥éª¤ï¼ˆçº¦å®š + ä½ é¡¹ç›®å®é™…å®ç°é£æ ¼ä¸€è‡´ï¼‰ 

1. ConversationServiceï¼šå†™å…¥ user messageã€æ‹‰å– summary+è¿‘æœŸæ¶ˆæ¯ï¼ˆä½ç½®å¾…ä½ è¡¥ï¼‰ 
2. ExcelServiceï¼šensure_cached / è¯»å– DataFrame ä¸ profileï¼ˆä½ç½®ï¼šä½ è´´è¿‡ `ExcelService.ensure_cached` è¢«è°ƒç”¨ï¼‰
3. AgentServiceï¼š

   * `plan_tools(df, question)` äº§å‡ºå·¥å…·è°ƒç”¨åºåˆ—ï¼ˆä½ ç°åœ¨æ˜¯çœŸå¤šæ­¥ï¼šè¶‹åŠ¿ä¼šå‡ºç° groupby/sort/chart/headï¼‰
   * `build_default_registry()` æ‹¿åˆ°å·¥å…·æ³¨å†Œè¡¨ï¼ˆä½ç½®ï¼šapp/services/tools/default_registry.pyï¼‰
   * é€ä¸ªæ‰§è¡Œå·¥å…·ï¼Œç”Ÿæˆ `tool_trace` ä¸ `artifacts`ï¼ˆä½ ç°åœ¨å·²ç»æ”¯æŒ chart å·¥å…·è¾“å‡ºï¼‰
4. LLMService/LLMProviderï¼š

   * `get_llm_provider()`ï¼šfake/openai å¯æ’æ‹”ï¼ˆä½ ç°åœ¨å·²ç»æ¥å…¥ env provider çš„æ€è·¯ï¼‰ 
5. ConversationServiceï¼šå†™å…¥ assistant messageï¼ˆextra.debugï¼‰å¹¶åˆ¤æ–­æ˜¯å¦è§¦å‘ summary

---

## 7. artifacts / chart specï¼ˆå¿…é¡»â€œå”¯ä¸€è§„èŒƒâ€ï¼Œä¸ç„¶å‰ç«¯å¿…ç‚¸ï¼‰

### 7.1 ğŸ“Œ å”¯ä¸€è§„èŒƒï¼ˆäº¤æ¥æ—¶åªèƒ½æœ‰ä¸€ç§ï¼‰

ğŸ“Œ çº¦å®šï¼šåç«¯æ‰€æœ‰å›¾è¡¨éƒ½è¿”å›ï¼š

```json
{
  "kind": "chart",
  "spec": {
    "type": "line",
    "x": ["Jan","Feb","Mar"],
    "series": [
      {"name": "sales", "data": [10, 20, 5]}
    ]
  }
}
```

### 7.2 å…³é”®è¯­ä¹‰ï¼ˆå’Œä½ æµ‹è¯•æœŸæœ›å¯¹é½ï¼‰

* `data` å…è®¸ `null`ï¼šç¼ºå¤±å€¼**å¿…é¡»ä¿ç•™ä¸º null**ï¼Œä¸èƒ½å˜ 0ï¼ˆä½ æœ‰ä¸“é—¨çš„æµ‹è¯•è¦†ç›–è¿™ä¸ªç‚¹ï¼‰
* `x` ä¸ `series[*].data` é•¿åº¦å¿…é¡»ä¸€è‡´
* `artifacts` æ°¸è¿œæ˜¯ listï¼ˆæ— å›¾æ—¶è¿”å›ç©º listï¼‰

âš ï¸ TODOï¼šæŠŠè¯¥è§„èŒƒå¯¹é½åˆ°çœŸå®å®ç°ï¼ˆä½ç½®åº”è¯¥åœ¨ `app/services/tools/pandas_tools.py` é‡Œé‚£äº› `chart_line*` å·¥å…·å‡½æ•°é‡Œï¼‰ã€‚

---

## 8. é”™è¯¯å“åº”å¥‘çº¦ï¼ˆç»™å‰ç«¯/åä½œè€…æœ€çœå‘½ï¼‰

ğŸ“Œ ç»Ÿä¸€é”™è¯¯ schemaï¼ˆå°±ç®—ç°åœ¨æ²¡å…¨å®ç°ï¼Œä¹Ÿå…ˆç«‹è§„çŸ©ï¼‰ï¼š

```json
{
  "code": "upload_too_large",
  "detail": "File too large. MAX_UPLOAD_MB=10",
  "meta": {"max_mb": 10}
}
```

ğŸ“Œ `/api/excel/upload` å¸¸è§é”™è¯¯

* 400ï¼šç¼º file / æ‰©å±•åé xlsx
* 413ï¼šè¶…è¿‡ MAX_UPLOAD_MB
* 500ï¼šopenpyxl/pandas è§£æå¤±è´¥

ğŸ“Œ `/api/excel/chat` å¸¸è§é”™è¯¯

* 404ï¼šsession_id / upload_id ä¸å­˜åœ¨
* 422ï¼šè¯·æ±‚ä½“ç¼ºå­—æ®µ
* 500ï¼šplanner æ‰§è¡Œå¤±è´¥ã€LLM è°ƒç”¨å¤±è´¥ã€DB å†™å…¥å¤±è´¥

---

## 9. Quickstartï¼ˆä» 0 åˆ°è·‘é€šï¼‰

ğŸ“Œ æœ€çŸ­é»„é‡‘è·¯å¾„ï¼ˆä½ äº¤æ¥ç»™åˆ«äººæ—¶å°±è®©ä»–ç…§åšï¼‰

1. é… `.env`ï¼ˆæä¾› `.env.example`ï¼Œå« DATABASE_URLã€ENVã€DATA_DIRã€LLM_PROVIDER ç­‰ï¼‰
2. åˆå§‹åŒ– MySQLï¼ˆæ‰§è¡Œä¸Šé¢çš„å»ºåº“æˆæƒ SQLï¼‰
3. è·‘æµ‹è¯•ï¼š

```powershell
pytest -q
```

4. å¯åŠ¨ï¼š

```powershell
uvicorn app.main:app --reload
```

5. èµ°ä¸€é upload â†’ chatï¼ˆSwagger æˆ–å‰ç«¯ï¼‰

---

## 10. æ•…éšœå‰§æœ¬ï¼ˆä½ å·²ç»è¸©è¿‡çš„å‘ï¼Œå†™è¿›æ¡£æ¡ˆå°±æ˜¯â€œç»éªŒèµ„äº§â€ï¼‰

* `ModuleNotFoundError: aiomysql`ï¼šä¾èµ–æ²¡è£…/æ²¡é”
* `cryptography package is required... caching_sha2_password`ï¼šè£… `cryptography` æˆ–è°ƒæ•´ MySQL auth plugin
* `Event loop is closed`ï¼ˆpytest ç»“æŸæ—¶ aiomysql è¿æ¥ææ„ï¼‰ï¼šä¸€èˆ¬æ˜¯è¿æ¥æ²¡æ˜¾å¼ closeï¼›å¯é€šè¿‡ fixture/engine dispose æ”¶æ•›
* `pytest_asyncio STRICT` è­¦å‘Š/é”™è¯¯ï¼špytest-asyncio æ¨¡å¼/fixture ä¸åŒ¹é…
* `tool already registered: chart_line_index`ï¼šregistry é‡å¤æ³¨å†Œï¼ˆdefault_registry é‡Œé‡å¤ registerï¼‰
* planner äº§å‡ºçš„ tool å mismatchï¼ˆä¾‹å¦‚æµ‹è¯•æœŸå¾… `sort`ï¼Œå®é™…æ˜¯ `sort_time`ï¼‰ï¼šç»Ÿä¸€ tool å‘½åæˆ–åš alias

---

# 11. ä½ è¦åšçš„â€œå†»ç»“ v1.1 çš„æœ€å 5 ä»¶å°äº‹â€ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

1. æŠŠ Python ç‰ˆæœ¬ã€requirements é”æ–‡ä»¶å†™æ­»ï¼ˆçœŸå®è¾“å‡º/çœŸå®æ–‡ä»¶åï¼‰
2. æ¯ä¸ªå…³é”®æ–­è¨€åè¡¥â€œä½ç½®ï¼šapp/...â€
3. artifacts spec **åªä¿ç•™ä¸€ç§**ï¼Œå¹¶ä»¥å·¥å…·å®ç°ä¸ºå‡†
4. é”™è¯¯ schema ç»Ÿä¸€ï¼ˆå‰ç«¯æ‰å¥½å†™ï¼‰
5. å¢åŠ ä¸€ä¸ªå¯å¤åˆ¶çš„ curl/httpx ç«¯åˆ°ç«¯ demoï¼ˆupload+chatï¼‰

---

å¦‚æœä½ ç¡®è®¤è¿™ä»½ v1.1 æ¡£æ¡ˆé£æ ¼/é¢—ç²’åº¦ç¬¦åˆä½ çš„â€œåˆ èŠå¤©è®°å½•ä»å¯æ¥æ‰‹â€ç›®æ ‡ï¼Œæˆ‘å°±å¼€å§‹åš**ç¬¬ 3 ä»¶äº‹ï¼šç®€å†é¡¹ç›®ä»‹ç»ï¼ˆå¹¶æ ‡æ³¨å“ªäº›æ˜¯åº“å‡½æ•°ã€å“ªäº›æ˜¯ä½ è‡ªå·±å†™çš„ï¼‰**ã€‚
